<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TOTP">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1f2937">
    <title>üîê Ë∫´‰ªΩÈ™åËØÅÂô®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #111827 0%, #1f2937 50%, #111827 100%);
            min-height: 100vh;
            color: #f3f4f6;
            display: flex;
            overflow: hidden;
        }
        
        .sidebar {
            width: 250px;
            background: rgba(31, 41, 55, 0.5);
            backdrop-filter: blur(10px);
            border-right: 1px solid #374151;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid #374151;
            flex-shrink: 0;
        }
        
        .sidebar-title {
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .group-list {
            flex: 1;
            overflow-y: auto;
            padding: 4px 0;
        }
        
        .group-list::-webkit-scrollbar {
            width: 4px;
        }
        
        .group-list::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .group-list::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 2px;
        }
        
        .group-list::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        .group-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid transparent;
        }
        
        .group-item:hover {
            background: rgba(75, 85, 99, 0.3);
        }
        
        .group-item.active {
            background: rgba(139, 92, 246, 0.2);
            border-left-color: #8b5cf6;
            font-weight: bold;
        }
        
        .group-count {
            background: #374151;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        
        .resizer {
            width: 4px;
            background: #374151;
            cursor: col-resize;
            flex-shrink: 0;
        }
        
        .resizer:hover, .resizer.dragging {
            background: #8b5cf6;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            height: 100vh;
            overflow: hidden;
        }
        
        .top-bar {
            background: rgba(31, 41, 55, 0.5);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #374151;
            padding: 16px 20px;
            flex-shrink: 0;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 4px;
        }
        
        .header p {
            font-size: 12px;
            color: #9ca3af;
        }
        
        .toolbar {
            display: flex;
            gap: 8px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .btn-primary {
            background: #8b5cf6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #7c3aed;
        }
        
        .btn-secondary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #2563eb;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .stats-bar {
            background: rgba(55, 65, 81, 0.5);
            padding: 12px 16px;
            border-radius: 8px;
            margin: 12px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: #d1d5db;
        }
        
        .timer {
            font-weight: bold;
        }
        
        .timer.ok { color: #10b981; }
        .timer.warn { color: #f59e0b; }
        .timer.danger { color: #ef4444; }
        
        .search-box {
            position: relative;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 10px 10px 36px;
            background: #374151;
            border: 2px solid #4b5563;
            border-radius: 8px;
            color: #f3f4f6;
            font-size: 14px;
            outline: none;
        }
        
        .search-box input:focus {
            border-color: #8b5cf6;
        }
        
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }
        
        .accounts-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            min-height: 0;
        }
        
        .accounts-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .accounts-container::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .accounts-container::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 3px;
        }
        
        .accounts-container::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        .card {
            background: rgba(31, 41, 55, 0.8);
            border: 1px solid #374151;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }
        
        .card:hover {
            border-color: #4b5563;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .card-info {
            flex: 1;
            min-width: 0;
        }
        
        .card-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 6px;
            color: #f9fafb;
        }
        
        .card-group {
            display: inline-block;
            background: #374151;
            color: #d1d5db;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
        }
        
        .card-actions {
            display: flex;
            gap: 6px;
        }
        
        .btn-icon {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            background: #374151;
            color: #9ca3af;
            font-size: 18px;
        }
        
        .btn-icon:hover {
            background: #4b5563;
        }
        
        .btn-delete {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
        
        .card-code {
            font-family: 'SF Mono', monospace;
            font-size: 32px;
            font-weight: bold;
            color: #a78bfa;
            text-align: center;
            letter-spacing: 4px;
            padding: 16px;
            background: rgba(17, 24, 39, 0.5);
            border-radius: 10px;
            cursor: pointer;
            user-select: none;
        }
        
        .card-code:hover {
            background: rgba(17, 24, 39, 0.8);
        }
        
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            font-size: 13px;
        }
        
        .copy-hint {
            color: #10b981;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .copy-hint.show {
            opacity: 1;
        }
        
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #9ca3af;
        }
        
        .empty-state h2 {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .empty-state p {
            font-size: 18px;
            margin-bottom: 30px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 16px;
            padding: 24px;
            width: 100%;
            max-width: 500px;
        }
        
        .modal-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: bold;
            color: #d1d5db;
            margin-bottom: 8px;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            background: #111827;
            border: 2px solid #374151;
            border-radius: 8px;
            color: #f3f4f6;
            font-size: 14px;
            outline: none;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            border-color: #8b5cf6;
        }
        
        .form-group textarea {
            min-height: 120px;
            font-family: monospace;
            resize: vertical;
        }
        
        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        .btn-gray {
            background: #374151;
            color: #f3f4f6;
        }
        
        .btn-gray:hover {
            background: #4b5563;
        }
        
        .footer {
            background: rgba(31, 41, 55, 0.5);
            border-top: 1px solid #374151;
            padding: 16px;
            text-align: center;
            font-size: 12px;
            color: #9ca3af;
            flex-shrink: 0;
        }
        
        .footer a {
            color: #8b5cf6;
            text-decoration: none;
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            body {
                flex-direction: column;
                height: 100vh;
                overflow: hidden;
            }
            
            .sidebar {
                width: 100%;
                height: 200px;
                max-height: 200px;
                flex-shrink: 0;
                border-right: none;
                border-bottom: 1px solid #374151;
            }
            
            .group-list {
                flex: 1;
                overflow-y: auto;
                height: calc(100% - 60px);
                -webkit-overflow-scrolling: touch;
            }
            
            .resizer {
                display: none;
            }
            
            .main-content {
                flex: 1;
                min-height: 0;
                overflow: hidden;
                height: calc(100vh - 200px);
            }
            
            .accounts-container {
                flex: 1;
                overflow-y: auto;
                height: 100%;
                padding: 15px;
                -webkit-overflow-scrolling: touch;
            }
            
            .top-bar {
                padding: 12px 15px;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                margin-bottom: 10px;
            }
            
            .header h1 {
                font-size: 20px;
                margin-bottom: 2px;
            }
            
            .toolbar {
                width: 100%;
                justify-content: space-between;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 12px;
                flex: 1;
            }
            
            .stats-bar {
                padding: 8px 12px;
                font-size: 12px;
                margin: 8px 0;
                flex-direction: column;
                gap: 8px;
            }
            
            .card {
                padding: 12px;
                margin-bottom: 10px;
            }
            
            .card-code {
                font-size: 24px;
                padding: 12px;
                letter-spacing: 2px;
            }
            
            .modal-content {
                margin: 10px;
                padding: 20px;
                max-height: 80vh;
                overflow-y: auto;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">üìÇ ÂàÜÁªÑ</div>
        </div>
        <div class="group-list" id="groupList"></div>
    </div>

    <div class="resizer" id="resizer"></div>

    <div class="main-content">
        <div class="top-bar">
            <div class="header">
                <div>
                    <h1>üîê Ë∫´‰ªΩÈ™åËØÅÂô®</h1>
                    <p>Á¶ªÁ∫øÁâà - Êï∞ÊçÆ‰ªÖÂ≠òÂú®Êú¨Âú∞ÊµèËßàÂô® | Êé®ÁâπÊ±Ç‰∏™ÂÖ≥Ê≥® ‚ù§Ô∏è <a href="https://twitter.com/CengBaofu" target="_blank">@CengBaofu</a></p>
                </div>
                <div class="toolbar">
                    <button class="btn btn-primary" onclick="showAddModal()">‚ûï Ê∑ªÂä†</button>
                    <button class="btn btn-secondary" onclick="showImportModal()">üì• ÂØºÂÖ•</button>
                    <button class="btn btn-success" onclick="exportData()">üì§ ÂØºÂá∫</button>
                </div>
            </div>

            <div class="stats-bar">
                <div id="statsBar">Âä†ËΩΩ‰∏≠...</div>
                <div class="timer ok" id="timerDisplay">‚è±Ô∏è 30s</div>
            </div>

            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" id="searchInput" placeholder="ÊêúÁ¥¢Ë¥¶Êà∑ÂêçÁß∞..." oninput="filterAccounts()">
            </div>
        </div>

        <div class="accounts-container">
            <div id="accountsList"></div>
        </div>
    </div>

    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">Ê∑ªÂä†Ë¥¶Êà∑</div>
            <div class="form-group">
                <label>Ë¥¶Êà∑ÂêçÁß∞ *</label>
                <input type="text" id="inputName" placeholder="‰æãÂ¶Ç: Google">
            </div>
            <div class="form-group">
                <label>ÂØÜÈí• (Secret) *</label>
                <input type="text" id="inputSecret" placeholder="‰æãÂ¶Ç: JBSWY3DPEHPK3PXP">
            </div>
            <div class="form-group">
                <label>ÂàÜÁªÑ</label>
                <input type="text" id="inputGroup" placeholder="‰æãÂ¶Ç: Â∑•‰Ωú">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-gray" style="flex:1" onclick="closeModal()">ÂèñÊ∂à</button>
                <button class="btn btn-primary" style="flex:1" onclick="saveAccount()">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-header">ÂØºÂÖ•ÈÖçÁΩÆ</div>
            <div class="form-group">
                <label>Á≤òË¥¥ JSON ÈÖçÁΩÆ</label>
                <textarea id="importData" placeholder='[{"name":"Google","secret":"JBSWY3DPEHPK3PXP","group":"Â∑•‰Ωú"}]'></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-gray" style="flex:1" onclick="closeImportModal()">ÂèñÊ∂à</button>
                <button class="btn btn-primary" style="flex:1" onclick="importAccounts()">ÂØºÂÖ•</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/hmac.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/sha1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/enc-base64.min.js"></script>
    <script>
        let accounts = [];
        let filteredAccounts = [];
        let selectedGroup = 'ÂÖ®ÈÉ®';
        let searchQuery = '';
        let editingIndex = -1;
        let codes = {};
        
        // ÂàùÂßãÂåñ‰∏Ä‰∫õÊµãËØïÊï∞ÊçÆÊù•ÊºîÁ§∫ÊªöÂä®
        function initTestData() {
            // Âè™ÊúâÂú®ÂÆåÂÖ®Ê≤°Êúâ‰ªª‰ΩïË¥¶Êà∑Êï∞ÊçÆÊó∂ÊâçÊ∑ªÂä†ÊµãËØïÊï∞ÊçÆ
            const saved = localStorage.getItem('totp_accounts');
            if (!saved || saved === '[]' || saved === 'null') {
                // Ê∑ªÂä†‰∏Ä‰∫õÊµãËØïÂàÜÁªÑÂíåÊï∞ÊçÆ
                const testAccounts = [
                    {name: 'Google', secret: 'JBSWY3DPEHPK3PXP', group: 'Â∑•‰Ωú'},
                    {name: 'GitHub', secret: 'JBSWY3DPEHPK3PXP', group: 'ÂºÄÂèë'},
                    {name: 'Outlook', secret: 'JBSWY3DPEHPK3PXP', group: '‰∏™‰∫∫'},
                    {name: 'Facebook', secret: 'JBSWY3DPEHPK3PXP', group: 'Á§æ‰∫§'},
                    {name: 'Twitter', secret: 'JBSWY3DPEHPK3PXP', group: 'Á§æ‰∫§'},
                    {name: 'Èì∂Ë°å', secret: 'JBSWY3DPEHPK3PXP', group: 'ÈáëËûç'},
                    {name: 'ÊîØ‰ªòÂÆù', secret: 'JBSWY3DPEHPK3PXP', group: 'ÈáëËûç'},
                    {name: 'Steam', secret: 'JBSWY3DPEHPK3PXP', group: 'Ê∏∏Êàè'},
                    {name: 'Epic Games', secret: 'JBSWY3DPEHPK3PXP', group: 'Ê∏∏Êàè'},
                    {name: 'AWS', secret: 'JBSWY3DPEHPK3PXP', group: 'Â∑•‰Ωú'},
                    {name: 'Azure', secret: 'JBSWY3DPEHPK3PXP', group: 'Â∑•‰Ωú'},
                    {name: 'Discord', secret: 'JBSWY3DPEHPK3PXP', group: 'Á§æ‰∫§'},
                    {name: 'Slack', secret: 'JBSWY3DPEHPK3PXP', group: 'Â∑•‰Ωú'},
                    {name: 'Trello', secret: 'JBSWY3DPEHPK3PXP', group: 'Â∑•‰Ωú'},
                    {name: 'Dropbox', secret: 'JBSWY3DPEHPK3PXP', group: 'Â∑•‰Ωú'},
                    {name: 'Evernote', secret: 'JBSWY3DPEHPK3PXP', group: '‰∏™‰∫∫'},
                    {name: 'LastPass', secret: 'JBSWY3DPEHPK3PXP', group: '‰∏™‰∫∫'},
                    {name: 'PayPal', secret: 'JBSWY3DPEHPK3PXP', group: 'ÈáëËûç'},
                    {name: 'ÂæÆ‰ø°', secret: 'JBSWY3DPEHPK3PXP', group: 'Á§æ‰∫§'},
                    {name: 'QQ', secret: 'JBSWY3DPEHPK3PXP', group: 'Á§æ‰∫§'},
                ];
                
                accounts = testAccounts;
                saveAccounts();
            }
        }
        
        // Base32 Ëß£Á†ÅÂáΩÊï∞
        function base32Decode(base32) {
            const base32Chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
            let bits = '';
            let result = '';
            
            base32 = base32.replace(/=+$/, '').toUpperCase();
            
            for (let i = 0; i < base32.length; i++) {
                const val = base32Chars.indexOf(base32[i]);
                if (val === -1) throw new Error('Invalid base32 character');
                bits += val.toString(2).padStart(5, '0');
            }
            
            for (let i = 0; i + 8 <= bits.length; i += 8) {
                const byte = bits.substr(i, 8);
                result += String.fromCharCode(parseInt(byte, 2));
            }
            
            return result;
        }
        
        // ÁîüÊàê TOTP ‰ª£Á†Å
        function generateTOTP(secret, window = 0) {
            try {
                // Ê∏ÖÁêÜÂØÜÈí•
                secret = secret.replace(/\s/g, '').toUpperCase();
                
                // Base32 Ëß£Á†Å
                const key = base32Decode(secret);
                
                // ËÆ°ÁÆóÊó∂Èó¥Ê≠•Èïø
                const timeStep = 30;
                let timestamp = Math.floor(Date.now() / 1000);
                let counter = Math.floor(timestamp / timeStep) + window;
                
                // Â∞ÜËÆ°Êï∞Âô®ËΩ¨Êç¢‰∏∫ 8 Â≠óËäÇÊï∞ÁªÑ
                const counterBytes = new Array(8);
                for (let i = 7; i >= 0; i--) {
                    counterBytes[i] = counter & 0xff;
                    counter = counter >> 8;
                }
                
                // ËÆ°ÁÆó HMAC-SHA1
                const hmac = CryptoJS.HmacSHA1(
                    CryptoJS.enc.Hex.parse(Array.from(counterBytes, byte => byte.toString(16).padStart(2, '0')).join('')),
                    CryptoJS.enc.Latin1.parse(key)
                );
                
                const hmacResult = hmac.toString(CryptoJS.enc.Hex);
                
                // Âä®ÊÄÅÊà™Âèñ
                const offset = parseInt(hmacResult.substr(39, 1), 16) & 0xf;
                const code = (
                    (parseInt(hmacResult.substr(offset * 2 + 0, 2), 16) & 0x7f) << 24 |
                    (parseInt(hmacResult.substr(offset * 2 + 2, 2), 16) & 0xff) << 16 |
                    (parseInt(hmacResult.substr(offset * 2 + 4, 2), 16) & 0xff) << 8 |
                    (parseInt(hmacResult.substr(offset * 2 + 6, 2), 16) & 0xff)
                ) % 1000000;
                
                return code.toString().padStart(6, '0');
            } catch (error) {
                console.error('TOTP generation error:', error);
                return '------';
            }
        }
        
        function init() {
            loadAccounts();
            
            // Âè™ÊúâÂú®Ê≤°Êúâ‰ªª‰ΩïÊï∞ÊçÆÊó∂ÊâçÂàùÂßãÂåñÊµãËØïÊï∞ÊçÆ
            // if (accounts.length === 0) {
            //     initTestData();
            // }
            
            renderUI();
            startUpdate();
            initResizer();
            
            // ÁßªÂä®Á´Ø‰ºòÂåñ
            if (window.innerWidth <= 768) {
                optimizeForMobile();
            }
        }
        
        function optimizeForMobile() {
            // Á°Æ‰øùÁßªÂä®Á´ØÊªöÂä®È°∫ÁïÖ
            document.body.style.webkitOverflowScrolling = 'touch';
            
            // Âª∂ËøüÊâßË°å‰ª•Á°Æ‰øùDOMÂÆåÂÖ®Âä†ËΩΩ
            setTimeout(() => {
                const groupList = document.getElementById('groupList');
                const accountsContainer = document.querySelector('.accounts-container');
                
                if (groupList) {
                    groupList.style.height = 'calc(100% - 60px)';
                }
                if (accountsContainer) {
                    accountsContainer.style.height = '100%';
                }
                
                // Âº∫Âà∂ÈáçÁªò‰ª•ÊøÄÊ¥ªÊªöÂä®
                if (groupList && groupList.scrollHeight > groupList.clientHeight) {
                    groupList.scrollTop = 1;
                    groupList.scrollTop = 0;
                }
                if (accountsContainer && accountsContainer.scrollHeight > accountsContainer.clientHeight) {
                    accountsContainer.scrollTop = 1;
                    accountsContainer.scrollTop = 0;
                }
            }, 100);
            
            // Ë∞ÉÊï¥ÂàùÂßãÂàÜÁªÑÈÄâÊã©
            if (accounts.length > 0) {
                selectGroup('ÂÖ®ÈÉ®');
            }
        }

        function loadAccounts() {
            const saved = localStorage.getItem('totp_accounts');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // Á°Æ‰øù accounts Ë¢´Ê≠£Á°ÆËµãÂÄº
                    accounts = Array.isArray(parsed) ? parsed : [];
                } catch(e) {
                    console.error('Ëß£ÊûêÊú¨Âú∞Êï∞ÊçÆÂ§±Ë¥•:', e);
                    accounts = [];
                }
            } else {
                accounts = [];
            }
        }
        
        function saveAccounts() {
            localStorage.setItem('totp_accounts', JSON.stringify(accounts));
        }
        
        function generateCode(secret) {
            return generateTOTP(secret);
        }
        
        function getRemaining() {
            return 30 - (Math.floor(Date.now() / 1000) % 30);
        }
        
        function renderUI() {
            renderGroups();
            filterAndRenderAccounts();
            updateStats();
        }
        
        function renderGroups() {
            const groups = ['ÂÖ®ÈÉ®', ...new Set(accounts.map(a => a.group || 'Êú™ÂàÜÁªÑ'))];
            const groupCounts = {};
            
            accounts.forEach(acc => {
                const g = acc.group || 'Êú™ÂàÜÁªÑ';
                groupCounts[g] = (groupCounts[g] || 0) + 1;
            });
            
            const html = groups.map(group => {
                const count = group === 'ÂÖ®ÈÉ®' ? accounts.length : (groupCounts[group] || 0);
                const active = group === selectedGroup ? 'active' : '';
                return `
                    <div class="group-item ${active}" onclick="selectGroup('${group}')">
                        <span>${group}</span>
                        <span class="group-count">${count}</span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('groupList').innerHTML = html;
        }
        
        function selectGroup(group) {
            selectedGroup = group;
            searchQuery = '';
            document.getElementById('searchInput').value = '';
            renderUI();
        }
        
        function filterAndRenderAccounts() {
            let filtered = accounts;
            if (selectedGroup !== 'ÂÖ®ÈÉ®') {
                filtered = filtered.filter(acc => (acc.group || 'Êú™ÂàÜÁªÑ') === selectedGroup);
            }
            
            if (searchQuery) {
                const query = searchQuery.toLowerCase();
                filtered = filtered.filter(acc => acc.name.toLowerCase().includes(query));
            }
            
            filteredAccounts = filtered;
            renderAccounts();
        }
        
        function filterAccounts() {
            searchQuery = document.getElementById('searchInput').value;
            filterAndRenderAccounts();
            updateStats();
        }
        
        function renderAccounts() {
            const accountsList = document.getElementById('accountsList');
            
            if (accounts.length === 0) {
                accountsList.innerHTML = `
                    <div class="empty-state">
                        <h2>üëã</h2>
                        <p>ËøòÊ≤°ÊúâÊ∑ªÂä†‰ªª‰ΩïË¥¶Êà∑<br>ÁÇπÂáª„ÄåÊ∑ªÂä†„ÄçÊåâÈíÆÂºÄÂßã</p>
                        <button class="btn btn-primary" onclick="showAddModal()">‚ûï Ê∑ªÂä†Á¨¨‰∏Ä‰∏™Ë¥¶Êà∑</button>
                    </div>
                `;
                return;
            }
            
            if (filteredAccounts.length === 0) {
                accountsList.innerHTML = '<div class="card"><p style="text-align:center;color:#9ca3af;">ÊöÇÊó†ÂåπÈÖçÁöÑË¥¶Êà∑</p></div>';
                return;
            }
            
            const html = filteredAccounts.map((acc, index) => {
                const realIndex = accounts.indexOf(acc);
                const code = generateCode(acc.secret);
                const remain = getRemaining();
                const timerClass = remain <= 5 ? 'danger' : remain <= 10 ? 'warn' : 'ok';
                
                return `
                    <div class="card">
                        <div class="card-header">
                            <div class="card-info">
                                <div class="card-name">${acc.name}</div>
                                <span class="card-group">üìÇ ${acc.group || 'Êú™ÂàÜÁªÑ'}</span>
                            </div>
                            <div class="card-actions">
                                <button class="btn-icon" onclick="editAccount(${realIndex})">‚úèÔ∏è</button>
                                <button class="btn-icon btn-delete" onclick="deleteAccount(${realIndex})">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="card-code" onclick="copyCode('${code}', ${realIndex})">
                            ${code}
                        </div>
                        <div class="card-footer">
                            <div class="timer ${timerClass}" id="timer-${realIndex}">‚è±Ô∏è ${remain}s</div>
                            <div class="copy-hint" id="hint-${realIndex}">‚úì Â∑≤Â§çÂà∂</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            accountsList.innerHTML = html;
        }
        
        function updateStats() {
            const total = accounts.length;
            const groups = new Set(accounts.map(a => a.group || 'Êú™ÂàÜÁªÑ')).size;
            const filtered = filteredAccounts.length;
            
            let stats = `üìä ÂÖ± ${total} ‰∏™Ë¥¶Êà∑ | üìÇ ${groups} ‰∏™ÂàÜÁªÑ`;
            if (searchQuery) {
                stats += ` | üîç ÊâæÂà∞ ${filtered} ‰∏™`;
            }
            if (selectedGroup !== 'ÂÖ®ÈÉ®') {
                stats += ` | üìÅ ÂΩìÂâç: ${selectedGroup}`;
            }
            
            document.getElementById('statsBar').innerHTML = stats;
        }
        
        function copyCode(code, index) {
            if (code === '------') return;
            
            const hint = document.getElementById(`hint-${index}`);
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(code).then(() => {
                    showCopyHint(hint);
                });
            } else {
                const textarea = document.createElement('textarea');
                textarea.value = code;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                showCopyHint(hint);
            }
        }
        
        function showCopyHint(hint) {
            if (!hint) return;
            hint.classList.add('show');
            setTimeout(() => hint.classList.remove('show'), 1500);
        }
        
        function updateCodes() {
            const remain = getRemaining();
            const timerClass = remain <= 5 ? 'danger' : remain <= 10 ? 'warn' : 'ok';
            
            const timerDisplay = document.getElementById('timerDisplay');
            timerDisplay.className = `timer ${timerClass}`;
            timerDisplay.innerHTML = `‚è±Ô∏è ${remain}s`;
            
            // ÊØè30ÁßíÂà∑Êñ∞‰∏ÄÊ¨°È™åËØÅÁ†Å
            if (remain === 30) {
                renderAccounts();
            } else {
                // Âè™Êõ¥Êñ∞Êó∂Èó¥ÊòæÁ§∫
                filteredAccounts.forEach((acc) => {
                    const realIndex = accounts.indexOf(acc);
                    const timerEl = document.getElementById(`timer-${realIndex}`);
                    if (timerEl) {
                        timerEl.className = `timer ${timerClass}`;
                        timerEl.innerHTML = `‚è±Ô∏è ${remain}s`;
                    }
                });
            }
        }
        
        function startUpdate() {
            setInterval(updateCodes, 1000);
        }
        
        function showAddModal() {
            editingIndex = -1;
            document.getElementById('modalTitle').textContent = 'Ê∑ªÂä†Ë¥¶Êà∑';
            document.getElementById('inputName').value = '';
            document.getElementById('inputSecret').value = '';
            document.getElementById('inputGroup').value = '';
            document.getElementById('editModal').classList.add('show');
        }
        
        function editAccount(index) {
            editingIndex = index;
            const acc = accounts[index];
            document.getElementById('modalTitle').textContent = 'ÁºñËæëË¥¶Êà∑';
            document.getElementById('inputName').value = acc.name;
            document.getElementById('inputSecret').value = acc.secret;
            document.getElementById('inputGroup').value = acc.group || '';
            document.getElementById('editModal').classList.add('show');
        }
        
        function saveAccount() {
            const name = document.getElementById('inputName').value.trim();
            const secret = document.getElementById('inputSecret').value.trim();
            const group = document.getElementById('inputGroup').value.trim();
            
            if (!name || !secret) {
                alert('ËØ∑Â°´ÂÜôË¥¶Êà∑ÂêçÁß∞ÂíåÂØÜÈí•');
                return;
            }
            
            const account = { name, secret, group: group || 'Êú™ÂàÜÁªÑ' };
            
            if (editingIndex >= 0) {
                accounts[editingIndex] = account;
            } else {
                accounts.push(account);
            }
            
            saveAccounts();
            closeModal();
            renderUI();
        }
        
        function deleteAccount(index) {
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§„Äå${accounts[index].name}„ÄçÂêó?`)) {
                accounts.splice(index, 1);
                saveAccounts();
                renderUI();
            }
        }
        
        function closeModal() {
            document.getElementById('editModal').classList.remove('show');
            editingIndex = -1;
        }
        
        function showImportModal() {
            document.getElementById('importData').value = '';
            document.getElementById('importModal').classList.add('show');
        }
        
        function closeImportModal() {
            document.getElementById('importModal').classList.remove('show');
        }
        
        function importAccounts() {
            const data = document.getElementById('importData').value.trim();
            
            if (!data) {
                alert('ËØ∑Á≤òË¥¥ÈÖçÁΩÆÊï∞ÊçÆ');
                return;
            }
            
            try {
                const imported = JSON.parse(data);
                
                if (!Array.isArray(imported)) {
                    alert('Ê†ºÂºèÈîôËØØ: Â∫îËØ•ÊòØ‰∏Ä‰∏™Êï∞ÁªÑ');
                    return;
                }
                
                imported.forEach(acc => {
                    if (acc.name && acc.secret) {
                        const exists = accounts.some(a => 
                            a.name === acc.name && a.secret === acc.secret
                        );
                        if (!exists) {
                            accounts.push({
                                name: acc.name,
                                secret: acc.secret,
                                group: acc.group || 'Êú™ÂàÜÁªÑ'
                            });
                        }
                    }
                });
                
                saveAccounts();
                closeImportModal();
                renderUI();
                alert(`‚úÖ ÊàêÂäüÂØºÂÖ• ${imported.length} ‰∏™Ë¥¶Êà∑`);
            } catch(e) {
                alert('‚ùå JSON Ê†ºÂºèÈîôËØØ: ' + e.message);
            }
        }
        
        function exportData() {
            if (accounts.length === 0) {
                alert('Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑË¥¶Êà∑');
                return;
            }
            
            const data = JSON.stringify(accounts, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `totp_backup_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(data).then(() => {
                    alert('‚úÖ Â∑≤ÂØºÂá∫Âπ∂Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
                }).catch(() => {
                    alert('‚úÖ Â∑≤ÂØºÂá∫Êñá‰ª∂');
                });
            } else {
                alert('‚úÖ Â∑≤ÂØºÂá∫Êñá‰ª∂');
            }
        }
        
        function initResizer() {
            const resizer = document.getElementById('resizer');
            const sidebar = document.getElementById('sidebar');
            let isResizing = false;
            
            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                resizer.classList.add('dragging');
                document.body.style.cursor = 'col-resize';
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                const newWidth = Math.max(200, Math.min(400, e.clientX));
                sidebar.style.width = newWidth + 'px';
            });
            
            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    resizer.classList.remove('dragging');
                    document.body.style.cursor = 'default';
                }
            });
        }
        
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
