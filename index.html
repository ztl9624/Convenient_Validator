<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TOTP">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#3498db">
    <title>üîêÈ™åËØÅÁ†ÅÁÆ°ÁêÜÂô®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .toolbar button {
            flex: 1;
            padding: 10px;
            background: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .toolbar button:active {
            transform: scale(0.95);
        }
        
        .search-box {
            background: white;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .search-box input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .card-info {
            flex: 1;
        }
        
        .card-name {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }
        
        .card-group {
            font-size: 11px;
            color: #888;
            background: #f0f0f0;
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
        }
        
        .card-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-icon {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
        }
        
        .btn-icon:active {
            transform: scale(0.9);
        }
        
        .btn-delete {
            background: #fee;
            color: #e74c3c;
        }
        
        .card-code {
            font-family: 'SF Mono', 'Consolas', 'Monaco', monospace;
            font-size: 28px;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            letter-spacing: 3px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
            position: relative;
        }
        
        .card-code:active {
            transform: scale(0.98);
            background: #e8e9ea;
        }
        
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }
        
        .card-timer {
            font-size: 13px;
            font-weight: bold;
        }
        
        .timer-ok { color: #2ecc71; }
        .timer-warn { color: #f39c12; }
        .timer-danger { color: #e74c3c; }
        
        .copy-hint {
            font-size: 12px;
            color: #2ecc71;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .copy-hint.show {
            opacity: 1;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: bold;
            color: #333;
            margin-bottom: 6px;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }
        
        .form-group textarea {
            min-height: 100px;
            font-family: monospace;
            resize: vertical;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: white;
        }
        
        .empty-state h2 {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        .empty-state p {
            font-size: 16px;
            margin-bottom: 30px;
            opacity: 0.9;
        }
        
        .empty-state button {
            background: white;
            color: #667eea;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .stats {
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 10px;
            color: white;
            text-align: center;
            margin-bottom: 15px;
            font-size: 13px;
        }
        
        .footer {
            text-align: center;
            color: white;
            margin-top: 30px;
            padding: 20px;
            font-size: 12px;
            opacity: 0.8;
        }
        
        .footer a {
            color: white;
            text-decoration: none;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Ë∫´‰ªΩÈ™åËØÅÂô®</h1>
            <p>Á¶ªÁ∫øÁâà - Êï∞ÊçÆ‰ªÖÂ≠òÂú®Êú¨Âú∞</p>
        </div>
        
        <div id="mainView">
            <div class="toolbar">
                <button onclick="showAddModal()">‚ûï Ê∑ªÂä†</button>
                <button onclick="showImportModal()">üì• ÂØºÂÖ•</button>
                <button onclick="exportData()">üì§ ÂØºÂá∫</button>
            </div>
            
            <div class="stats" id="stats">
                Âä†ËΩΩ‰∏≠...
            </div>
            
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="üîç ÊêúÁ¥¢Ë¥¶Êà∑..." oninput="filterAccounts()">
            </div>
            
            <div id="accountsList"></div>
        </div>
        
        <div id="emptyView" class="empty-state" style="display:none;">
            <h2>üëã</h2>
            <p>ËøòÊ≤°ÊúâÊ∑ªÂä†‰ªª‰ΩïË¥¶Êà∑<br>ÁÇπÂáª‰∏ãÊñπÊåâÈíÆÂºÄÂßãÊ∑ªÂä†</p>
            <button onclick="showAddModal()">‚ûï Ê∑ªÂä†Á¨¨‰∏Ä‰∏™Ë¥¶Êà∑</button>
        </div>
        
        <div class="footer">
            <p>Ê±Ç‰∏™ÂÖ≥Ê≥®Ë∞¢Ë∞¢ <a href="https://twitter.com/CengBaofu" target="_blank">@CengBaofu</a></p>
        </div>
    </div>

    <!-- Ê∑ªÂä†/ÁºñËæëË¥¶Êà∑ÂºπÁ™ó -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">Ê∑ªÂä†Ë¥¶Êà∑</div>
            <div class="form-group">
                <label>Ë¥¶Êà∑ÂêçÁß∞ *</label>
                <input type="text" id="inputName" placeholder="‰æãÂ¶Ç: Google">
            </div>
            <div class="form-group">
                <label>ÂØÜÈí• (Secret) *</label>
                <input type="text" id="inputSecret" placeholder="‰æãÂ¶Ç: JBSWY3DPEHPK3PXP">
            </div>
            <div class="form-group">
                <label>ÂàÜÁªÑ</label>
                <input type="text" id="inputGroup" placeholder="‰æãÂ¶Ç: Â∑•‰Ωú">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal()">ÂèñÊ∂à</button>
                <button class="btn btn-primary" onclick="saveAccount()">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <!-- ÂØºÂÖ•ÂºπÁ™ó -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-header">ÂØºÂÖ•ÈÖçÁΩÆ</div>
            <div class="form-group">
                <label>Á≤òË¥¥ JSON ÈÖçÁΩÆ</label>
                <textarea id="importData" placeholder='[{"name":"Google","secret":"JBSWY3DPEHPK3PXP","group":"Â∑•‰Ωú"}]'></textarea>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeImportModal()">ÂèñÊ∂à</button>
                <button class="btn btn-primary" onclick="importAccounts()">ÂØºÂÖ•</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsOTP/2.0.0/jsOTP.min.js"></script>
    <script>
        let accounts = [];
        let searchQuery = '';
        let editingIndex = -1;
        
        // ÂàùÂßãÂåñ
        function init() {
            loadAccounts();
            renderUI();
            startUpdate();
        }
        
        // Âä†ËΩΩË¥¶Êà∑
        function loadAccounts() {
            const saved = localStorage.getItem('totp_accounts');
            if (saved) {
                try {
                    accounts = JSON.parse(saved);
                } catch(e) {
                    console.error('Ëß£ÊûêÂ§±Ë¥•', e);
                    accounts = [];
                }
            }
        }
        
        // ‰øùÂ≠òË¥¶Êà∑
        function saveAccounts() {
            localStorage.setItem('totp_accounts', JSON.stringify(accounts));
        }
        
        // ÁîüÊàêÈ™åËØÅÁ†Å
        function generateCode(secret) {
            try {
                secret = secret.replace(/\s|-/g, '').toUpperCase();
                const totp = new jsOTP.totp();
                return totp.getOtp(secret);
            } catch(e) {
                return '------';
            }
        }
        
        // Ëé∑ÂèñÂâ©‰ΩôÊó∂Èó¥
        function getRemaining() {
            return 30 - (Math.floor(Date.now() / 1000) % 30);
        }
        
        // Ê∏≤ÊüìUI
        function renderUI() {
            if (accounts.length === 0) {
                document.getElementById('mainView').style.display = 'none';
                document.getElementById('emptyView').style.display = 'block';
            } else {
                document.getElementById('mainView').style.display = 'block';
                document.getElementById('emptyView').style.display = 'none';
                updateStats();
                renderAccounts();
            }
        }
        
        // Êõ¥Êñ∞ÁªüËÆ°
        function updateStats() {
            const total = accounts.length;
            const filtered = getFilteredAccounts().length;
            const groups = [...new Set(accounts.map(a => a.group || 'Êú™ÂàÜÁªÑ'))].length;
            
            document.getElementById('stats').textContent = 
                `ÂÖ± ${total} ‰∏™Ë¥¶Êà∑ | ${groups} ‰∏™ÂàÜÁªÑ` + 
                (searchQuery ? ` | ÊâæÂà∞ ${filtered} ‰∏™` : '');
        }
        
        // Ëé∑ÂèñËøáÊª§ÂêéÁöÑË¥¶Êà∑
        function getFilteredAccounts() {
            if (!searchQuery) return accounts;
            
            return accounts.filter(acc => 
                acc.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                (acc.group && acc.group.toLowerCase().includes(searchQuery.toLowerCase()))
            );
        }
        
        // ËøáÊª§Ë¥¶Êà∑
        function filterAccounts() {
            searchQuery = document.getElementById('searchInput').value;
            renderAccounts();
            updateStats();
        }
        
        // Ê∏≤ÊüìË¥¶Êà∑ÂàóË°®
        function renderAccounts() {
            const filtered = getFilteredAccounts();
            
            if (filtered.length === 0) {
                document.getElementById('accountsList').innerHTML = 
                    '<div class="card"><p style="text-align:center;color:#888;">ÊöÇÊó†ÂåπÈÖçÁöÑË¥¶Êà∑</p></div>';
                return;
            }
            
            const html = filtered.map((acc, idx) => {
                const realIndex = accounts.indexOf(acc);
                const code = acc.secret ? generateCode(acc.secret) : '------';
                const remain = getRemaining();
                const timerClass = remain <= 5 ? 'timer-danger' : remain <= 10 ? 'timer-warn' : 'timer-ok';
                
                return `
                    <div class="card">
                        <div class="card-header">
                            <div class="card-info">
                                <div class="card-name">${acc.name}</div>
                                <span class="card-group">üìÇ ${acc.group || 'Êú™ÂàÜÁªÑ'}</span>
                            </div>
                            <div class="card-actions">
                                <button class="btn-icon" onclick="editAccount(${realIndex})" title="ÁºñËæë">‚úèÔ∏è</button>
                                <button class="btn-icon btn-delete" onclick="deleteAccount(${realIndex})" title="Âà†Èô§">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="card-code" onclick="copyCode(this, '${code}')" data-idx="${realIndex}">
                            ${code}
                        </div>
                        <div class="card-footer">
                            <div class="card-timer ${timerClass}" id="timer-${realIndex}">
                                ‚è±Ô∏è ${remain}s
                            </div>
                            <div class="copy-hint" id="hint-${realIndex}">‚úì Â∑≤Â§çÂà∂</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('accountsList').innerHTML = html;
        }
        
        // Â§çÂà∂È™åËØÅÁ†Å
        function copyCode(element, code) {
            if (code === '------') return;
            
            const idx = element.dataset.idx;
            const hint = document.getElementById(`hint-${idx}`);
            
            // Â§çÂà∂
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(code).then(() => {
                    showCopyHint(hint);
                }).catch(() => {
                    fallbackCopy(code, hint);
                });
            } else {
                fallbackCopy(code, hint);
            }
        }
        
        // ÈôçÁ∫ßÂ§çÂà∂ÊñπÊ°à
        function fallbackCopy(text, hint) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showCopyHint(hint);
            } catch(e) {
                alert('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂Ôºö' + text);
            }
            document.body.removeChild(textarea);
        }
        
        // ÊòæÁ§∫Â§çÂà∂ÊèêÁ§∫
        function showCopyHint(hint) {
            if (!hint) return;
            hint.classList.add('show');
            setTimeout(() => hint.classList.remove('show'), 1500);
        }
        
        // Êõ¥Êñ∞ÂÄíËÆ°Êó∂
        function updateCodes() {
            const remain = getRemaining();
            
            accounts.forEach((acc, idx) => {
                const timerEl = document.getElementById(`timer-${idx}`);
                if (timerEl) {
                    const timerClass = remain <= 5 ? 'timer-danger' : remain <= 10 ? 'timer-warn' : 'timer-ok';
                    timerEl.className = `card-timer ${timerClass}`;
                    timerEl.textContent = `‚è±Ô∏è ${remain}s`;
                }
            });
            
            if (remain === 30) {
                renderAccounts();
            }
        }
        
        // ÂêØÂä®Êõ¥Êñ∞
        function startUpdate() {
            setInterval(updateCodes, 1000);
        }
        
        // ÊòæÁ§∫Ê∑ªÂä†ÂºπÁ™ó
        function showAddModal() {
            editingIndex = -1;
            document.getElementById('modalTitle').textContent = 'Ê∑ªÂä†Ë¥¶Êà∑';
            document.getElementById('inputName').value = '';
            document.getElementById('inputSecret').value = '';
            document.getElementById('inputGroup').value = '';
            document.getElementById('editModal').classList.add('show');
        }
        
        // ÁºñËæëË¥¶Êà∑
        function editAccount(index) {
            editingIndex = index;
            const acc = accounts[index];
            document.getElementById('modalTitle').textContent = 'ÁºñËæëË¥¶Êà∑';
            document.getElementById('inputName').value = acc.name;
            document.getElementById('inputSecret').value = acc.secret;
            document.getElementById('inputGroup').value = acc.group || '';
            document.getElementById('editModal').classList.add('show');
        }
        
        // ‰øùÂ≠òË¥¶Êà∑
        function saveAccount() {
            const name = document.getElementById('inputName').value.trim();
            const secret = document.getElementById('inputSecret').value.trim();
            const group = document.getElementById('inputGroup').value.trim();
            
            if (!name) {
                alert('ËØ∑ËæìÂÖ•Ë¥¶Êà∑ÂêçÁß∞');
                return;
            }
            
            if (!secret) {
                alert('ËØ∑ËæìÂÖ•ÂØÜÈí•');
                return;
            }
            
            const account = { name, secret, group: group || 'Êú™ÂàÜÁªÑ' };
            
            if (editingIndex >= 0) {
                accounts[editingIndex] = account;
            } else {
                accounts.push(account);
            }
            
            saveAccounts();
            closeModal();
            renderUI();
        }
        
        // Âà†Èô§Ë¥¶Êà∑
        function deleteAccount(index) {
            if (confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§„Äå${accounts[index].name}„ÄçÂêóÔºü`)) {
                accounts.splice(index, 1);
                saveAccounts();
                renderUI();
            }
        }
        
        // ÂÖ≥Èó≠ÂºπÁ™ó
        function closeModal() {
            document.getElementById('editModal').classList.remove('show');
        }
        
        // ÊòæÁ§∫ÂØºÂÖ•ÂºπÁ™ó
        function showImportModal() {
            document.getElementById('importData').value = '';
            document.getElementById('importModal').classList.add('show');
        }
        
        // ÂÖ≥Èó≠ÂØºÂÖ•ÂºπÁ™ó
        function closeImportModal() {
            document.getElementById('importModal').classList.remove('show');
        }
        
        // ÂØºÂÖ•Ë¥¶Êà∑
        function importAccounts() {
            const data = document.getElementById('importData').value.trim();
            
            if (!data) {
                alert('ËØ∑Á≤òË¥¥ÈÖçÁΩÆÊï∞ÊçÆ');
                return;
            }
            
            try {
                const imported = JSON.parse(data);
                
                if (!Array.isArray(imported)) {
                    alert('Ê†ºÂºèÈîôËØØÔºöÂ∫îËØ•ÊòØ‰∏Ä‰∏™Êï∞ÁªÑ');
                    return;
                }
                
                // ÂêàÂπ∂Ë¥¶Êà∑ÔºàÈÅøÂÖçÈáçÂ§çÔºâ
                imported.forEach(acc => {
                    if (acc.name && acc.secret) {
                        const exists = accounts.some(a => 
                            a.name === acc.name && a.secret === acc.secret
                        );
                        if (!exists) {
                            accounts.push({
                                name: acc.name,
                                secret: acc.secret,
                                group: acc.group || 'Êú™ÂàÜÁªÑ'
                            });
                        }
                    }
                });
                
                saveAccounts();
                closeImportModal();
                renderUI();
                alert(`‚úÖ ÊàêÂäüÂØºÂÖ• ${imported.length} ‰∏™Ë¥¶Êà∑`);
                
            } catch(e) {
                alert('‚ùå JSON Ê†ºÂºèÈîôËØØÔºö' + e.message);
            }
        }
        
        // ÂØºÂá∫Êï∞ÊçÆ
        function exportData() {
            if (accounts.length === 0) {
                alert('Ê≤°ÊúâÂèØÂØºÂá∫ÁöÑË¥¶Êà∑');
                return;
            }
            
            const data = JSON.stringify(accounts, null, 2);
            
            // ÂàõÂª∫‰∏ãËΩΩ
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `totp_backup_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            // ÂêåÊó∂Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(data).then(() => {
                    alert('‚úÖ Â∑≤ÂØºÂá∫Âπ∂Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
                }).catch(() => {
                    alert('‚úÖ Â∑≤ÂØºÂá∫Êñá‰ª∂');
                });
            } else {
                alert('‚úÖ Â∑≤ÂØºÂá∫Êñá‰ª∂');
            }
        }
        
        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        init();
    </script>
</body>
</html>
